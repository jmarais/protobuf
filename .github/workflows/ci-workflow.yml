name: Continuous Integration
on:
  push:
    branches:
      - master

jobs:
  build_and_test:
    name: Build server all go-${{ matrix.go_version }} and protobuf-${{ matrix.protobuf_version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go_version: [1.12.x]
        protobuf_version: [3.7.1]
    steps:
      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v1
        with:
          path: gopath/src/github.com/gogo/protobuf
      - name: Setup go-${{ matrix.go_version }}
        uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.go_version }}
      - name: Setup protoc
        env:
          PROTOBUF_VERSION: ${{ matrix.protobuf_version }}
        run: ./install-protobuf.sh
      - name: Protoc version
        run: PATH=$HOME/bin:$PATH protoc --version
      - name: env
        run: env && go env && pwd
      - name: Build server all
        run: GOPATH=/home/runner/work/protobuf/gopath GOBIN=$GOPATH/bin PATH=$HOME/bin:$GOBIN:$PATH make buildserverall
      - name: Diff check
        if: matrix.protobuf_version == '3.7.1' && matrix.go_version == '1.12.x'
        run: ! git status --porcelain | read || (git status; git diff; exit 1)

